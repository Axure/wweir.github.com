<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="chrome=1">
		<title></title>
		<style text="text/css">
body {
    overflow-x: hidden;
}
.container {
		margin: 0 auto;
		width: 1020px;
}
.nav-wrap {
    display: block;
    height: 650px;
    float: left;
    position: fixed;
		padding: 3px;
		margin: 0;
		border: 0;
		font: 13px Helvetica, arial, freesans, clean, sans-serif;
		line-height: 1.4;
    
}
.nav {
		display: block;
		float: left;
		position: fixed;
		padding: 3px;
		border-radius: 2px;
		margin: 40px 0 0 0;
		border: 0;
		font: 13px Helvetica, arial, freesans, clean, sans-serif;
		line-height: 1.4;
    background: #ffffff; overflow: hidden;
}
.nav ul {
		background: #fafafb;
		border-radius: 2px;
		border: 1px solid #d8d8d8;
		margin: 0;
		padding: 0;
		list-style: none;
		display: block;
}
.nav ul li {
		display: list-item;
		border-top: 1px solid #fff;
		border-bottom: 1px solid #eee;
}
.nav ul li a {
		display: block;
		padding: 8px 10px 8px 8px;
		text-shadow: 0 1px 0 #fff;
		border-left: 2px solid #fafafb;
		color: #4183c4;
		text-decoration: none;
}
.nav ul li a:-webkit-any-link {
		cursor: auto;
}
.markdown-body {
		font: 13px Helvetica, arial, freesans, clean, sans-serif;
		display: block;
		width: 800px;
    margin: 0 auto;
    font-size: 14px;
    line-height: 1.6;
}
.markdown-body > *:first-child {
    margin-top: 0 !important;
}
.markdown-body > *:last-child {
    margin-bottom: 0 !important;
}
.markdown-body a {
    text-decoration: none;
}
.markdown-body a:hover {
    text-decoration: underline;
}
.markdown-body a.absent {
    color: #CC0000;
}
.markdown-body a.anchor {
    bottom: 0;
    cursor: pointer;
    display: block;
    left: 0;
    margin-left: -30px;
    padding-left: 30px;
    position: absolute;
    top: 0;
}
.markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6 {
    cursor: text;
    font-weight: bold;
    margin: 20px 0 10px;
    padding: 0;
    position: relative;
}
.markdown-body h1 .mini-icon-link, .markdown-body h2 .mini-icon-link, .markdown-body h3 .mini-icon-link, .markdown-body h4 .mini-icon-link, .markdown-body h5 .mini-icon-link, .markdown-body h6 .mini-icon-link {
    color: #000000;
    display: none;
}
.markdown-body h1:hover a.anchor, .markdown-body h2:hover a.anchor, .markdown-body h3:hover a.anchor, .markdown-body h4:hover a.anchor, .markdown-body h5:hover a.anchor, .markdown-body h6:hover a.anchor {
    line-height: 1;
    margin-left: -22px;
    padding-left: 0;
    text-decoration: none;
    top: 15%;
}
.markdown-body h1:hover a.anchor .mini-icon-link, .markdown-body h2:hover a.anchor .mini-icon-link, .markdown-body h3:hover a.anchor .mini-icon-link, .markdown-body h4:hover a.anchor .mini-icon-link, .markdown-body h5:hover a.anchor .mini-icon-link, .markdown-body h6:hover a.anchor .mini-icon-link {
    display: inline-block;
}
.markdown-body h1 tt, .markdown-body h1 code, .markdown-body h2 tt, .markdown-body h2 code, .markdown-body h3 tt, .markdown-body h3 code, .markdown-body h4 tt, .markdown-body h4 code, .markdown-body h5 tt, .markdown-body h5 code, .markdown-body h6 tt, .markdown-body h6 code {
    font-size: inherit;
}
.markdown-body h1 {
    color: #000000;
    font-size: 28px;
}
.markdown-body h2 {
    border-bottom: 1px solid #CCCCCC;
    color: #000000;
    font-size: 24px;
}
.markdown-body h3 {
    font-size: 18px;
}
.markdown-body h4 {
    font-size: 16px;
}
.markdown-body h5 {
    font-size: 14px;
}
.markdown-body h6 {
    color: #777777;
    font-size: 14px;
}
.markdown-body p, .markdown-body blockquote, .markdown-body ul, .markdown-body ol, .markdown-body dl, .markdown-body table, .markdown-body pre {
    margin: 15px 0;
}
.markdown-body li ul, .markdown-body li ol {
    margin-top: 0;
}
.markdown-body hr {
    border: 0 none;
    color: #CCCCCC;
    height: 4px;
    padding: 0;
}
.markdown-body > h2:first-child, .markdown-body > h1:first-child, .markdown-body > h1:first-child + h2, .markdown-body > h3:first-child, .markdown-body > h4:first-child, .markdown-body > h5:first-child, .markdown-body > h6:first-child {
    margin-top: 0;
    padding-top: 0;
}
.markdown-body a:first-child h1, .markdown-body a:first-child h2, .markdown-body a:first-child h3, .markdown-body a:first-child h4, .markdown-body a:first-child h5, .markdown-body a:first-child h6 {
    margin-top: 0;
    padding-top: 0;
}
.markdown-body h1 + p, .markdown-body h2 + p, .markdown-body h3 + p, .markdown-body h4 + p, .markdown-body h5 + p, .markdown-body h6 + p {
    margin-top: 0;
}
.markdown-body li p.first {
    display: inline-block;
}
.markdown-body ul, .markdown-body ol {
    padding-left: 30px;
}
.markdown-body ul.no-list, .markdown-body ol.no-list {
    list-style-type: none;
    padding: 0;
}
.markdown-body ul li > *:first-child, .markdown-body ol li > *:first-child {
    margin-top: 0;
}
.markdown-body ul ul, .markdown-body ul ol, .markdown-body ol ol, .markdown-body ol ul {
    margin-bottom: 0;
}
.markdown-body dl {
    padding: 0;
}
.markdown-body dl dt {
    font-size: 14px;
    font-style: italic;
    font-weight: bold;
    margin: 15px 0 5px;
    padding: 0;
}
.markdown-body dl dt:first-child {
    padding: 0;
}
.markdown-body dl dt > *:first-child {
    margin-top: 0;
}
.markdown-body dl dt > *:last-child {
    margin-bottom: 0;
}
.markdown-body dl dd {
    margin: 0 0 15px;
    padding: 0 15px;
}
.markdown-body dl dd > *:first-child {
    margin-top: 0;
}
.markdown-body dl dd > *:last-child {
    margin-bottom: 0;
}
.markdown-body blockquote {
    border-left: 4px solid #DDDDDD;
    color: #777777;
    padding: 0 15px;
}
.markdown-body blockquote > *:first-child {
    margin-top: 0;
}
.markdown-body blockquote > *:last-child {
    margin-bottom: 0;
}
.markdown-body table th {
    font-weight: bold;
}
.markdown-body table th, .markdown-body table td {
    border: 1px solid #CCCCCC;
    padding: 6px 13px;
}
.markdown-body table tr {
    background-color: #FFFFFF;
    border-top: 1px solid #CCCCCC;
}
.markdown-body table tr:nth-child(2n) {
    background-color: #F8F8F8;
}
.markdown-body img {
    max-width: 100%;
}
.markdown-body span.frame {
    display: block;
    overflow: hidden;
}
.markdown-body span.frame > span {
    border: 1px solid #DDDDDD;
    display: block;
    float: left;
    margin: 13px 0 0;
    overflow: hidden;
    padding: 7px;
    width: auto;
}
.markdown-body span.frame span img {
    display: block;
    float: left;
}
.markdown-body span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0;
}
.markdown-body span.align-center {
    clear: both;
    display: block;
    overflow: hidden;
}
.markdown-body span.align-center > span {
    display: block;
    margin: 13px auto 0;
    overflow: hidden;
    text-align: center;
}
.markdown-body span.align-center span img {
    margin: 0 auto;
    text-align: center;
}
.markdown-body span.align-right {
    clear: both;
    display: block;
    overflow: hidden;
}
.markdown-body span.align-right > span {
    display: block;
    margin: 13px 0 0;
    overflow: hidden;
    text-align: right;
}
.markdown-body span.align-right span img {
    margin: 0;
    text-align: right;
}
.markdown-body span.float-left {
    display: block;
    float: left;
    margin-right: 13px;
    overflow: hidden;
}
.markdown-body span.float-left span {
    margin: 13px 0 0;
}
.markdown-body span.float-right {
    display: block;
    float: right;
    margin-left: 13px;
    overflow: hidden;
}
.markdown-body span.float-right > span {
    display: block;
    margin: 13px auto 0;
    overflow: hidden;
    text-align: right;
}
.markdown-body code, .markdown-body tt {
		font-family: Consolas, "Liberation Mono", Courier, monospace;
    background-color: #F8F8F8;
    border: 1px solid #EAEAEA;
    border-radius: 3px 3px 3px 3px;
    margin: 0 2px;
    padding: 0 5px;
    white-space: nowrap;
}
.markdown-body pre > code {
		font-size: 14px;
    background: none repeat scroll 0 0 transparent;
    border: medium none;
    margin: 0;
    padding: 0;
    white-space: pre;
}
.markdown-body .highlight pre, .markdown-body pre {
    background-color: #F8F8F8;
    border: 1px solid #CCCCCC;
    border-radius: 3px 3px 3px 3px;
    font-size: 13px;
    line-height: 19px;
    overflow: auto;
    padding: 6px 10px;
}
.markdown-body pre code, .markdown-body pre tt {
    background-color: transparent;
    border: medium none;
}
.container .logo {
    display: block;
    text-align: right;
    font-size: 10px;
}

		</style>
	</head>
	<body>
  <div class="container">
    <div class="nav-wrap">
      <div class="nav"></div>
      
    </div>
  	<div class="markdown-body"><h1>14.4 用户认证</h1>

<p>在开发Web应用过程中，用户认证是开发者经常遇到的问题，用户登录、注册、登出等操作，而一般认证也分为三个方面的认证</p>

<ul>
<li>HTTP Basic和 HTTP Digest认证</li>
<li>第三方集成认证：QQ、微博、豆瓣、OPENID、google、github、facebook和twitter等</li>
<li>自定义的用户登录、注册、登出，一般都是基于session、cookie认证</li>
</ul>

<p>beego目前没有针对这三种方式进行任何形式的集成，但是可以充分的利用第三方开源库来实现上面的三种方式的用户认证，不过后续beego会对前面两种认证逐步集成。</p>

<h2>HTTP Basic和 HTTP Digest认证</h2>

<p>这两个认证是一些应用采用的比较简单的认证，目前已经有开源的第三方库支持这两个认证：</p>

<pre><code>github.com/abbot/go-http-auth 
</code></pre>

<p>下面代码演示了如何把这个库引入beego中从而实现认证：</p>

<pre><code>package controllers

import (
    &#34;github.com/abbot/go-http-auth&#34;
    &#34;github.com/astaxie/beego&#34;
)

func Secret(user, realm string) string {
    if user == &#34;john&#34; {
        // password is &#34;hello&#34;
        return &#34;$1$dlPL2MqE$oQmn16q49SqdmhenQuNgs1&#34;
    }
    return &#34;&#34;
}

type MainController struct {
    beego.Controller
}

func (this *MainController) Prepare() {
    a := auth.NewBasicAuthenticator(&#34;example.com&#34;, Secret)
    if username := a.CheckAuth(this.Ctx.Request); username == &#34;&#34; {
        a.RequireAuth(this.Ctx.ResponseWriter, this.Ctx.Request)
    }
}

func (this *MainController) Get() {
    this.Data[&#34;Username&#34;] = &#34;astaxie&#34;
    this.Data[&#34;Email&#34;] = &#34;astaxie@gmail.com&#34;
    this.TplNames = &#34;index.tpl&#34;
}
</code></pre>

<p>上面代码利用了beego的prepare函数，在执行正常逻辑之前调用了认证函数，这样就非常简单的实现了http auth，digest的认证也是同样的原理。</p>

<h2>oauth和oauth2的认证</h2>

<p>oauth和oauth2是目前比较流行的两种认证方式，还好第三方有一个库实现了这个认证，但是是国外实现的，并没有QQ、微博之类的国内应用认证集成：</p>

<pre><code>github.com/bradrydzewski/go.auth
</code></pre>

<p>下面代码演示了如何把该库引入beego中从而实现oauth的认证，这里以github为例演示：</p>

<ol>
<li><p>添加两条路由</p>

<pre><code>beego.RegisterController(&#34;/auth/login&#34;, &amp;controllers.GithubController{})
beego.RegisterController(&#34;/mainpage&#34;, &amp;controllers.PageController{})
</code></pre></li>

<li><p>然后我们处理GithubController登陆的页面：</p>

<pre><code>package controllers


import (
    &#34;github.com/astaxie/beego&#34;
    &#34;github.com/bradrydzewski/go.auth&#34;
)


const (
    githubClientKey = &#34;a0864ea791ce7e7bd0df&#34;
    githubSecretKey = &#34;a0ec09a647a688a64a28f6190b5a0d2705df56ca&#34;
)


type GithubController struct {
    beego.Controller
}


func (this *GithubController) Get() {
    // set the auth parameters
    auth.Config.CookieSecret = []byte(&#34;7H9xiimk2QdTdYI7rDddfJeV&#34;)
    auth.Config.LoginSuccessRedirect = &#34;/mainpage&#34;
    auth.Config.CookieSecure = false


    githubHandler := auth.Github(githubClientKey, githubSecretKey)


    githubHandler.ServeHTTP(this.Ctx.ResponseWriter, this.Ctx.Request)
}
</code></pre></li>

<li><p>处理登陆成功之后的页面</p>

<pre><code>package controllers


import (
    &#34;github.com/astaxie/beego&#34;
    &#34;github.com/bradrydzewski/go.auth&#34;
    &#34;net/http&#34;
    &#34;net/url&#34;
)


type PageController struct {
    beego.Controller
}


func (this *PageController) Get() {
    // set the auth parameters
    auth.Config.CookieSecret = []byte(&#34;7H9xiimk2QdTdYI7rDddfJeV&#34;)
    auth.Config.LoginSuccessRedirect = &#34;/mainpage&#34;
    auth.Config.CookieSecure = false


    user, err := auth.GetUserCookie(this.Ctx.Request)


    //if no active user session then authorize user
    if err != nil || user.Id() == &#34;&#34; {
        http.Redirect(this.Ctx.ResponseWriter, this.Ctx.Request, auth.Config.LoginRedirect, http.StatusSeeOther)
        return
    }


    //else, add the user to the URL and continue
    this.Ctx.Request.URL.User = url.User(user.Id())
    this.Data[&#34;pic&#34;] = user.Picture()
    this.Data[&#34;id&#34;] = user.Id()
    this.Data[&#34;name&#34;] = user.Name()
    this.TplNames = &#34;home.tpl&#34;
}
</code></pre></li>
</ol>

<p>整个的流程如下，首先打开浏览器输入地址：</p>

<p><img src="images/14.4.github.png?raw=true" alt=""></img>
</p>

<p>图14.4 显示带有登录按钮的首页</p>

<p>然后点击链接出现如下界面：</p>

<p><img src="images/14.4.github2.png?raw=true" alt=""></img>
</p>

<p>图14.5 点击登录按钮后显示github的授权页</p>

<p>然后点击Authorize app就出现如下界面：</p>

<p><img src="images/14.4.github3.png?raw=true" alt=""></img>
</p>

<p>图14.6 授权登录之后显示的获取到的github信息页</p>

<h2>自定义认证</h2>

<p>自定义的认证一般都是和session结合的验证的，如下代码来源于一个基于beego的开源博客：</p>

<pre><code>//登陆处理
func (this *LoginController) Post() {
    this.TplNames = &#34;login.tpl&#34;
    this.Ctx.Request.ParseForm()
    username := this.Ctx.Request.Form.Get(&#34;username&#34;)
    password := this.Ctx.Request.Form.Get(&#34;password&#34;)
    md5Password := md5.New()
    io.WriteString(md5Password, password)
    buffer := bytes.NewBuffer(nil)
    fmt.Fprintf(buffer, &#34;%x&#34;, md5Password.Sum(nil))
    newPass := buffer.String()

    now := time.Now().Format(&#34;2006-01-02 15:04:05&#34;)

    userInfo := models.GetUserInfo(username)
    if userInfo.Password == newPass {
        var users models.User
        users.Last_logintime = now
        models.UpdateUserInfo(users)

        //登录成功设置session
        sess := globalSessions.SessionStart(this.Ctx.ResponseWriter, this.Ctx.Request)
        sess.Set(&#34;uid&#34;, userInfo.Id)
        sess.Set(&#34;uname&#34;, userInfo.Username)

        this.Ctx.Redirect(302, &#34;/&#34;)
    }   
}

//注册处理
func (this *RegController) Post() {
    this.TplNames = &#34;reg.tpl&#34;
    this.Ctx.Request.ParseForm()
    username := this.Ctx.Request.Form.Get(&#34;username&#34;)
    password := this.Ctx.Request.Form.Get(&#34;password&#34;)
    usererr := checkUsername(username)
    fmt.Println(usererr)
    if usererr == false {
        this.Data[&#34;UsernameErr&#34;] = &#34;Username error, Please to again&#34;
        return
    }

    passerr := checkPassword(password)
    if passerr == false {
        this.Data[&#34;PasswordErr&#34;] = &#34;Password error, Please to again&#34;
        return
    }

    md5Password := md5.New()
    io.WriteString(md5Password, password)
    buffer := bytes.NewBuffer(nil)
    fmt.Fprintf(buffer, &#34;%x&#34;, md5Password.Sum(nil))
    newPass := buffer.String()

    now := time.Now().Format(&#34;2006-01-02 15:04:05&#34;)

    userInfo := models.GetUserInfo(username)

    if userInfo.Username == &#34;&#34; {
        var users models.User
        users.Username = username
        users.Password = newPass
        users.Created = now
        users.Last_logintime = now
        models.AddUser(users)

        //登录成功设置session
        sess := globalSessions.SessionStart(this.Ctx.ResponseWriter, this.Ctx.Request)
        sess.Set(&#34;uid&#34;, userInfo.Id)
        sess.Set(&#34;uname&#34;, userInfo.Username)
        this.Ctx.Redirect(302, &#34;/&#34;)
    } else {
        this.Data[&#34;UsernameErr&#34;] = &#34;User already exists&#34;
    }

}

func checkPassword(password string) (b bool) {
    if ok, _ := regexp.MatchString(&#34;^[a-zA-Z0-9]{4,16}$&#34;, password); !ok {
        return false
    }
    return true
}

func checkUsername(username string) (b bool) {
    if ok, _ := regexp.MatchString(&#34;^[a-zA-Z0-9]{4,16}$&#34;, username); !ok {
        return false
    }
    return true
}
</code></pre>

<p>有了用户登陆和注册之后，其他模块的地方可以增加如下这样的用户是否登陆的判断：</p>

<pre><code>func (this *AddBlogController) Prepare() {
    sess := globalSessions.SessionStart(this.Ctx.ResponseWriter, this.Ctx.Request)
    sess_uid := sess.Get(&#34;userid&#34;)
    sess_username := sess.Get(&#34;username&#34;)
    if sess_uid == nil {
        this.Ctx.Redirect(302, &#34;/admin/login&#34;)
        return
    }
    this.Data[&#34;Username&#34;] = sess_username
}
</code></pre>

<h2>links</h2>

<ul>
<li><a href="preface.html">目录</a></li>
<li>上一节: <a href="14.3.html">表单及验证支持</a></li>
<li>下一节: <a href="14.5.html">多语言支持</a></li>
</ul>
<div class="logo">Generated by <a href="https://github.com/fairlyblank/md2min">md2min</a></div></div>
  <div>
	</body>
</html>
